# Documentation Django - Signals, T√¢ches Celery et Fichiers non-API

## Vue d'ensemble
Ce document documente tous les Django signals, t√¢ches Celery et fichiers non-API √† travers tous les modules du projet NoCode Backend.

---

## Module Foundation

### Django Signals
**Fichier:** `apps/foundation/signals/user_signals.py`

#### `user_post_save` (post_save sur User)
- **D√©clencheur:** Cr√©ation d'un nouvel utilisateur
- **Fonction:** Log l'information de cr√©ation d'utilisateur
- **Code:** `logger.info(f"Nouvel utilisateur cr√©√© : {instance.email}")`
- **Usage:** Audit et suivi des cr√©ations de comptes

### T√¢ches Celery
**Aucune t√¢che Celery trouv√©e dans le module foundation**

### Fichiers non-API cl√©s
- **Services:** `services/` - Logique m√©tier (auth_service.py, billing_service.py)
- **Admin:** `admin.py` - Configuration Django Admin
- **Migrations:** `migrations/` - Historique des migrations de base de donn√©es
- **Management:** Aucune commandes management personnalis√©es

---

## Module Automation

### Django Signals
**Fichier:** `apps/automation/signals.py`

#### `workflow_saved` (post_save sur Workflow)
- **D√©clencheur:** Cr√©ation ou mise √† jour d'un workflow
- **Fonction:** Publie des √©v√©nements sur EventBus pour tracking
- **√âv√©nements:** `automation.workflow.created` ou `automation.workflow.updated`
- **Donn√©es:** workflow_id, name, organization_id, status
- **Usage:** Tracking temps r√©el des changements de workflows

#### `workflow_deleted` (pre_delete sur Workflow)
- **D√©clencheur:** Suppression d'un workflow
- **Fonction:** Publie √©v√©nement `automation.workflow.deleted`
- **Usage:** Nettoyage et audit des suppressions

#### `workflow_execution_status_changed` (post_save sur WorkflowExecution)
- **D√©clencheur:** Changement de statut d'ex√©cution
- **Fonction:** Publie √©v√©nements de cycle de vie
- **√âv√©nements:** `automation.execution.started`, `automation.execution.completed/failed/cancelled`
- **Usage:** Monitoring et notifications d'ex√©cution

#### `integration_saved` (post_save sur Integration)
- **D√©clencheur:** Cr√©ation d'int√©gration
- **Fonction:** Publie `automation.integration.created`
- **Usage:** Tracking des configurations d'int√©grations

### T√¢ches Celery
**Fichier:** `apps/automation/tasks.py`

#### `execute_workflow_async`
- **Purpose:** Ex√©cution asynchrone de workflows avec retry
- **Retries:** 3 tentatives avec backoff exponentiel
- **Usage:** Point d'entr√©e principal pour l'ex√©cution de workflows

#### `process_webhook_trigger`
- **Purpose:** Traite les d√©clencheurs webhook
- **Flow:** Trigger ‚Üí V√©rification ‚Üí Lancement workflow
- **Usage:** Int√©grations externes et automatisations d√©clench√©es

#### `process_scheduled_triggers`
- **Purpose:** Ex√©cute les triggers cron (planifi√©s)
- **Frequency:** Chaque minute via Celery Beat
- **Usage:** Automatisations temporelles et t√¢ches r√©currentes

#### `cleanup_old_executions`
- **Purpose:** Nettoie les ex√©cutions anciennes (>30 jours par d√©faut)
- **Scope:** Supprime completed/failed/cancelled
- **Usage:** Maintenance et optimisation de la base de donn√©es

#### `cleanup_stale_executions`
- **Purpose:** Marque comme √©chou√©es les ex√©cutions bloqu√©es (>2 heures)
- **Scope:** Statut 'running' expir√©
- **Usage:** Pr√©vention des deadlocks et ressources bloqu√©es

#### `send_workflow_notification`
- **Purpose:** Envoie notifications via EventBus
- **Types:** completed, failed, etc.
- **Usage:** Alertes utilisateur et monitoring

#### `retry_failed_step`
- **Purpose:** R√©essaie une √©tape √©chou√©e sp√©cifique
- **Context:** Pr√©serve le contexte d'ex√©cution existant
- **Usage:** R√©cup√©ration d'erreurs granulaire

#### `export_workflow_execution_logs`
- **Purpose:** Exporte les logs d'ex√©cution au format JSON
- **Output:** Structure compl√®te avec timestamps et d√©tails
- **Usage:** Audit, debugging et analyse post-mortem

#### `update_integration_stats`
- **Purpose:** Met √† jour les statistiques d'int√©grations
- **Source:** Agr√©gation depuis Redis/cache
- **Usage:** Monitoring de performance et health checks

### Fichiers non-API cl√©s
- **Services:** Logique d'ex√©cution de workflows
- **Models:** Mod√®les complexes de workflows, n≈ìuds, edges
- **Admin:** Configuration pour l'administration des workflows

---

## Module Studio

### Django Signals
**Fichier:** `apps/studio/signals.py`

#### `delete_project_schema` (pre_delete sur Project)
- **D√©clencheur:** Suppression d'un projet
- **Fonction:** Supprime le sch√©ma PostgreSQL associ√© via SchemaManager
- **Usage:** Nettoyage complet des donn√©es de projet en base de donn√©es
- **S√©curit√©:** Pr√©vient l'accumulation de sch√©mas orphelins

#### `create_public_functions` (post_migrate)
- **D√©clencheur:** Migration du module studio
- **Fonction:** Cr√©e fonctions et triggers PostgreSQL automatiques
- **Composants:**
  - `update_updated_at_column()` - Met √† jour automatiquement le champ updated_at
  - `create_updated_at_trigger()` - Cr√©e triggers sur toutes les tables
  - Event trigger `on_table_created` - Applique updated_at aux nouvelles tables
- **Usage:** Automatisation de la gestion des timestamps en base de donn√©es

### T√¢ches Celery
**Aucune t√¢che Celery trouv√©e dans le module studio**

### Fichiers non-API cl√©s
- **SchemaManager:** Gestion des sch√©mas PostgreSQL par projet
- **Services:** Logique de gestion de projets et pages
- **Models:** Mod√®les de projets, pages, sch√©mas de donn√©es

---

## Module Runtime

### Django Signals
**Fichier:** `apps/runtime/signals.py`

#### `log_model_changes` (post_save global)
- **D√©clencheur:** Tous les post_save sur tous les mod√®les
- **Fonction:** Log universel des cr√©ations et mises √† jour
- **Format:** `Created {ModelName}: {id}` ou `Updated {ModelName}: {id}`
- **Usage:** Debugging et audit g√©n√©ral des changements
- **Performance:** Peut √™tre verbeux en production

### T√¢ches Celery
**Aucune t√¢che Celery trouv√©e dans le module runtime**

### Fichiers non-API cl√©s
- **Services:** Logique de d√©ploiement et ex√©cution d'applications
- **Models:** Mod√®les d'applications g√©n√©r√©es, logs de d√©ploiement
- **Deployment:** Configuration et gestion des d√©ploiements

---

## Module Insights

### Django Signals
**Fichier:** `apps/insights/signals.py`

#### `track_user_login` (user_logged_in)
- **D√©clencheur:** Connexion utilisateur r√©ussie
- **Fonction:** Track via ActivityTracker.track_login()
- **Donn√©es:** User, request, timestamp
- **Usage:** Analytics de s√©curit√© et d'engagement

#### `track_user_logout` (user_logged_out)
- **D√©clencheur:** D√©connexion utilisateur
- **Fonction:** Track via ActivityTracker.track_logout()
- **Usage:** Analytics de sessions et de s√©curit√©

#### `track_organization_changes` (post_save sur Organization)
- **D√©clencheur:** Cr√©ation ou mise √† jour d'organisation
- **Fonction:** Track actions utilisateur via ActivityTracker
- **Actions:** `organization.created` ou `organization.updated`
- **Contexte:** Owner de l'organisation comme utilisateur source

#### `track_project_changes` (post_save sur Project)
- **D√©clencheur:** Cr√©ation ou mise √† jour de projet
- **Fonction:** Track via ActivityTracker.track_project_action()
- **Actions:** `created` ou `updated`
- **Usage:** Analytics d'activit√© de d√©veloppement

#### `track_app_changes` (post_save sur GeneratedApp)
- **D√©clencheur:** Changement de statut d'application g√©n√©r√©e
- **Fonction:** Track via ActivityTracker.track_app_action()
- **Actions:** `created`, `deployed`, `failed`
- **Usage:** Analytics de d√©ploiement et performance

### T√¢ches Celery
**Aucune t√¢che Celery trouv√©e dans le module insights**

### Fichiers non-API cl√©s
- **ActivityTracker:** Service principal de tracking d'activit√©
- **Models:** UserActivity, analytics, m√©triques
- **Services:** Logique d'analyse et de reporting

---

## Fichiers de Configuration Globale

### T√¢ches Celery
- **Fichier principal:** `config/celery.py` - Configuration Celery
- **Beat Schedule:** T√¢ches p√©riodiques planifi√©es

### Management Commands
- **create_superuser.py** - Script de cr√©ation de superutilisateur
- **Autres commandes personnalis√©es dans les modules*

---

## Nettoyage Effectu√©

### Fichiers Supprim√©s
- ‚úÖ `apps/foundation/urls_v1.py` - Ancienne version des URLs (doublon)
- ‚úÖ `create_admin.py` - Script admin en double de create_superuser.py

### Imports Corrig√©s
- ‚úÖ `billing_serializers.py` - Correction des imports de mod√®les
- ‚úÖ Restauration des APIs Foundation dans Swagger

### Prochaines √âtapes de Nettoyage
- üîÑ Suppression des commentaires inutiles dans tous les modules
- üîÑ Standardisation des formats de documentation
- üîÑ Optimisation des imports et d√©pendances

---

*Derni√®re mise √† jour: 21 Nov 2025*
*Statut: Documentation en cours - Signals et t√¢ches Celery √† d√©tailler*
